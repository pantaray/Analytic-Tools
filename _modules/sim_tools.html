<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sim_tools</title>
    
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/myaddon.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Analytic Tools Documentation</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://www.masseyeandear.org/research/otolaryngology/investigators/laboratories/simonyanlab">Dystonia and Motor Control Laboratory</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Browse <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Welcome to the Analytic Tools Documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#getting-started">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#network-science">Network Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#interactive-brain-network-visualization">Interactive Brain Network Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#intracranial-eeg-data-processing">Intracranial EEG Data Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#comparative-statistics">Comparative Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#general-purpose-convenience-functions">General-Purpose Convenience Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html#neural-population-modeling">Neural Population Modeling</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.degrees_und.html">nws_tools.degrees_und</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.strengths_und.html">nws_tools.strengths_und</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.density_und.html">nws_tools.density_und</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.get_corr.html">nws_tools.get_corr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.mutual_info.html">nws_tools.mutual_info</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.corrcheck.html">nws_tools.corrcheck</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.rm_negatives.html">nws_tools.rm_negatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.rm_selfies.html">nws_tools.rm_selfies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.issym.html">nws_tools.issym</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.get_meannw.html">nws_tools.get_meannw</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.thresh_nws.html">nws_tools.thresh_nws</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.generate_randnws.html">nws_tools.generate_randnws</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.shownet.html">nws_tools.shownet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.show_nw.html">nws_tools.show_nw</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.csv2dict.html">nws_tools.csv2dict</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.normalize.html">nws_tools.normalize</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.nw_zip.html">nws_tools.nw_zip</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.hdfburp.html">nws_tools.hdfburp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.printdata.html">nws_tools.printdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/nws_tools.img2vid.html">nws_tools.img2vid</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/plotly_tools.cmap_plt2js.html">plotly_tools.cmap_plt2js</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/plotly_tools.make_brainsurf.html">plotly_tools.make_brainsurf</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/eeg_tools.read_eeg.html">eeg_tools.read_eeg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/eeg_tools.load_data.html">eeg_tools.load_data</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/eeg_tools.bandpass_filter.html">eeg_tools.bandpass_filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/eeg_tools.MA.html">eeg_tools.MA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/eeg_tools.time2ind.html">eeg_tools.time2ind</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/stats_tools.perm_test.html">stats_tools.perm_test</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/stats_tools.printstats.html">stats_tools.printstats</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/recipes.natural_sort.html">recipes.natural_sort</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/recipes.regexfind.html">recipes.regexfind</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/recipes.query_yes_no.html">recipes.query_yes_no</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/recipes.myglob.html">recipes.myglob</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/recipes.get_numlines.html">recipes.get_numlines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/recipes.moveit.html">recipes.moveit</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/sim_tools.run_model.html">sim_tools.run_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/sim_tools.make_bold.html">sim_tools.make_bold</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/sim_tools.plot_sim.html">sim_tools.plot_sim</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/sim_tools.show_params.html">sim_tools.show_params</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_stubs/sim_tools.make_D.html">sim_tools.make_D</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Navigate <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for sim_tools</h1><div class="highlight"><pre>
<span></span><span class="c1"># sim_tools.py - Routines for running a model simulation</span>
<span class="c1"># </span>
<span class="c1"># Author: Stefan Fuertinger [stefan.fuertinger@esi-frankfurt.de]</span>
<span class="c1"># Created: June 23 2014</span>
<span class="c1"># Last modified: &lt;2017-09-15 16:46:31&gt;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">ipdb</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">texttable</span> <span class="k">import</span> <span class="n">Texttable</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">nipy.modalities.fmri</span> <span class="k">import</span> <span class="n">hrf</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">from</span> <span class="nn">recipes</span> <span class="k">import</span> <span class="n">moveit</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">the_model</span> <span class="k">import</span> <span class="n">par</span><span class="p">,</span> <span class="n">solve_model</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">WARNING: Could not import the model - `run_model` will not work!&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Try running `make all` in a terminal first&quot;</span>

<span class="c1">##########################################################################################</span>
<div class="viewcode-block" id="run_model"><a class="viewcode-back" href="../_stubs/sim_tools.run_model.html#sim_tools.run_model">[docs]</a><span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="n">V0</span><span class="p">,</span> <span class="n">Z0</span><span class="p">,</span> <span class="n">DA0</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> \
              <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">paramfile</span><span class="o">=</span><span class="s1">&#39;parameters.py&#39;</span><span class="p">,</span> <span class="n">symsyn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ram_use</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>\
              <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a simulation using the neural population model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    V0 : NumPy 1darray</span>
<span class="sd">        Initial conditions for excitatory neurons. If `N` regions are simulated then `V0` has </span>
<span class="sd">        to have length `N`.</span>
<span class="sd">    Z0 : NumPy 1darray</span>
<span class="sd">        Initial conditions for inhibitory neurons. If `N` regions are simulated then `Z0` has </span>
<span class="sd">        to have length `N`.</span>
<span class="sd">    DA0 : NumPy 1darray</span>
<span class="sd">        Initial conditions for dopamine levels. If `N` regions are simulated then `DA0` has </span>
<span class="sd">        to have length `N`.</span>
<span class="sd">    task : str</span>
<span class="sd">        Specify which task should be simulated. Currently, only &#39;rest&#39; and &#39;speech&#39; are supported. </span>
<span class="sd">    outfile : str</span>
<span class="sd">        File-name (including path if not in working directory) of HDF5 container that will be created to </span>
<span class="sd">        save simulation results. See Notes for the structure of the generated container. Any existing </span>
<span class="sd">        file will be renamed. The user has to have writing permissions for the given location.</span>
<span class="sd">    seed : int</span>
<span class="sd">        Random number generator seed. To make meaningful comparisons between successive simulation</span>
<span class="sd">        runs, the random number seed should be fixed so that the solver uses the same Wiener process</span>
<span class="sd">        realizations. Also, if synaptic coupling strengths are sampled from a probability distribution,</span>
<span class="sd">        simulation results will vary from run to run unless the seed is fixed. </span>
<span class="sd">    paramfile : str</span>
<span class="sd">        Parameter file-name (including path if not in working directory) that should be used for simulation. </span>
<span class="sd">        The parameter file has to be a Python file (.py extension). For more details refer to `Examples` </span>
<span class="sd">        below. You should have received a sample parameter file (`parameters.py`) with this copy </span>
<span class="sd">        of `sim_tools.py`. </span>
<span class="sd">    symsyn : bool</span>
<span class="sd">        Boolean switch determining whether synaptic coupling strengths should be symmetrized between </span>
<span class="sd">        hemispheres (`symsyn=True`) or not. </span>
<span class="sd">    verbose : bool</span>
<span class="sd">        If `True` the code will print a summary of the most important parameters and all used </span>
<span class="sd">        keyword arguments (see below) in the simulation together with a progress bar to (roughly)</span>
<span class="sd">        estimate run time (requires the `progressbar` module). </span>
<span class="sd">    ram_use : float</span>
<span class="sd">        Fraction of memory to use for caching simulation results before writing to disk </span>
<span class="sd">        (0 &lt; `ram_use` &lt; 1). More available memory means fewer disk-writes and thus better performance, </span>
<span class="sd">        i.e, the larger `ram_use` the faster this code runs. However, if too much RAM is allocated by </span>
<span class="sd">        this routine it may stall the executing computer. By default, `ram_use = 0.2`, i.e., around 20% </span>
<span class="sd">        of available memory is used. </span>
<span class="sd">    kwargs : additional keyword arguments</span>
<span class="sd">        Instead of relying solely on a static file to define parameter values, it is also possible</span>
<span class="sd">        to pass on parameters to the code using keyword arguments (see `Examples` below). Note: parameters</span>
<span class="sd">        given as keyword arguments have higher priority than values set in `paramfile`, i.e., if </span>
<span class="sd">        `p1 = 1` is defined in `paramfile` but `p1 = 2` is a keyword argument, the code will use </span>
<span class="sd">        `p1 = 2` in the simulation. This behavior was intentionally implemented to enable the use </span>
<span class="sd">        of this function within a parameter identification framework. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing : None</span>
<span class="sd">        Simulation results are saved in the HDF5 container specified by `outfile`. See `Notes` for details. </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Due to the (usually) high temporal resolution of simulations, results are not kept in memory (and </span>
<span class="sd">    thus returned as variable in the caller&#39;s work-space) but saved directly to disk using the HDF5</span>
<span class="sd">    container `outfile`. The code uses the HDF library&#39;s data chunking feature to save entire</span>
<span class="sd">    segments on disk while running. By default the code will allocate around 20% of available </span>
<span class="sd">    memory to cache simulation results. Hence, more memory leads to fewer disk-writes during </span>
<span class="sd">    run-time and thus faster performance. </span>
<span class="sd">    The structure of the generated output container is as follows: all state variables and the dopaminergic </span>
<span class="sd">    gain `Beta` are stored at the top-level of the file. Additionally, the employed coupling </span>
<span class="sd">    matrix `C` and dopamine connection matrix `D` are also saved in the top level group. All used parameters</span>
<span class="sd">    are saved in the subgroup `params`. </span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Let `V0`, `Z0`, and `DA0` (NumPy 1darrays of length `N`) be initial conditions of the</span>
<span class="sd">    model. Assuming that a valid parameter file (called `parameters.py`) is located in the current </span>
<span class="sd">    working directory, the following call will run a resting state simulation and save the output</span>
<span class="sd">    in the HDF5 container `sim_rest.h5`</span>

<span class="sd">    &gt;&gt;&gt; run_model(V0,Z0,DA0,&#39;rest&#39;,&#39;sim_rest.h5&#39;)</span>

<span class="sd">    Assume another parameter file, say, `par_patho.py` hold parameter settings simulating a </span>
<span class="sd">    certain pathology. Then the command</span>

<span class="sd">    &gt;&gt;&gt; run_model(V0,Z0,DA0,&#39;rest&#39;,&#39;patho/sim_rest_patho.h5&#39;,paramfile=&#39;par_patho.py&#39;)</span>

<span class="sd">    runs a resting state simulation with the same initial conditions and saves the result in</span>
<span class="sd">    the container `sim_rest_patho.h5` in the sub-directory `patho` (which must already exist, otherwise</span>
<span class="sd">    an error is raised). </span>

<span class="sd">    If only one or two parameters should be changed from their values found in a given parameter file, </span>
<span class="sd">    it is probably more handy to change the value of these parameters from the command line, rather</span>
<span class="sd">    than to write a separate parameter file (that is identical to the original one except for two </span>
<span class="sd">    values). Thus, assume the values of `VK` and `VL` should be -0.4 and -0.9 respectively, i.e., </span>
<span class="sd">    different than those found in (the otherwise fine) `par_patho.py`. Then the command</span>

<span class="sd">    &gt;&gt;&gt; run_model(V0,Z0,DA0,&#39;rest&#39;,&#39;patho/sim_rest_patho.h5&#39;,paramfile=&#39;par_patho.py&#39;,VK=-0.4,VL=-0.9)</span>
<span class="sd">    </span>
<span class="sd">    runs the same resting state simulation as above but with `VK=-0.4` and `VL=-0.9`. This feature</span>
<span class="sd">    can also be used to efficiently embed `run_model` in a parameter identification framework.</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    plot_sim : plot simulations generated by run_model</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] S. Fuertinger, J. C. Zinn, and K. Simonyan. A Neural Population Model Incorporating </span>
<span class="sd">           Dopaminergic Neurotransmission during Complex Voluntary Behaviors. PLoS Computational Biology, </span>
<span class="sd">           10(11), 2014. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sanity checks for initial conditions</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;V0&#39;</span><span class="p">,</span><span class="s1">&#39;Z0&#39;</span><span class="p">,</span><span class="s1">&#39;DA0&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">V0</span><span class="p">,</span> <span class="n">Z0</span><span class="p">,</span> <span class="n">DA0</span><span class="p">]):</span>
        <span class="n">arrcheck</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span><span class="s1">&#39;vector&#39;</span><span class="p">,</span><span class="n">vnames</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">size</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The initial conditions for `V`, `Z`, and `DA` have to have the same length!&#39;</span><span class="p">)</span>
        
    <span class="c1"># Check the `task` string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Task has to be specified as string, not &#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>
    <span class="n">task</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">!=</span> <span class="s1">&#39;rest&#39;</span> <span class="ow">and</span> <span class="n">task</span> <span class="o">!=</span> <span class="s1">&#39;speech&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The value of `task` has to be either &#39;rest&#39; or &#39;speech&#39;!&quot;</span><span class="p">)</span>

    <span class="c1"># The path to the output file should be a valid</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outfile</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Output filename has to be a string!&#39;</span><span class="p">)</span>
    <span class="n">outfile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">outfile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">outfile</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">slash</span> <span class="o">=</span> <span class="n">outfile</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slash</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">outfile</span><span class="p">[:</span><span class="n">outfile</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)]):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid path for output file: &#39;</span><span class="o">+</span><span class="n">outfile</span><span class="o">+</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>

    <span class="c1"># Set or get random number generator seed</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scalarcheck</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

    <span class="c1"># Make sure `paramfile` is a valid path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">paramfile</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Parameter file has to be specified using a string!&#39;</span><span class="p">)</span>
    <span class="n">paramfile</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">paramfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">paramfile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">paramfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">paramfile</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">paramfile</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Parameter file: &#39;</span><span class="o">+</span><span class="n">paramfile</span><span class="o">+</span><span class="s1">&#39; does not exist!&#39;</span><span class="p">)</span>

    <span class="c1"># Make sure `symsyn` and `verbose` are Boolean</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">symsyn</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The switch `symsyn` has to be Boolean!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The switch `verbose` has to be Boolean!&quot;</span><span class="p">)</span>

    <span class="c1"># Finally, check `ram_use`</span>
    <span class="n">scalarcheck</span><span class="p">(</span><span class="n">ram_use</span><span class="p">,</span><span class="s1">&#39;ram_use&#39;</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Append &#39;.h5&#39; extension to `outfile` if necessary</span>
    <span class="k">if</span> <span class="n">outfile</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.h5&#39;</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span>

    <span class="c1"># Check if `paramfile` has an extension, if yes, rip it off</span>
    <span class="k">if</span> <span class="n">paramfile</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.py&#39;</span><span class="p">:</span>
        <span class="n">paramfile</span> <span class="o">=</span> <span class="n">paramfile</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1"># Divide `paramfile` into file-name and path</span>
    <span class="n">slash</span> <span class="o">=</span> <span class="n">paramfile</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slash</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pth</span>   <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">paramfile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pth</span>   <span class="o">=</span> <span class="n">paramfile</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">slash</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">paramfile</span><span class="p">[</span><span class="n">slash</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>

    <span class="c1"># Import parameters module and initialize corresponding dictionary (remove `__file__`, etc)</span>
    <span class="n">param_py</span> <span class="o">=</span> <span class="n">imp</span><span class="o">.</span><span class="n">load_module</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="o">*</span><span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="n">fname</span><span class="p">,[</span><span class="n">pth</span><span class="p">]))</span>
    <span class="n">p_dict</span>   <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">param_py</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;__&quot;</span><span class="p">:</span>
            <span class="n">p_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Try to load coupling and dopamine pathway matrices</span>
    <span class="n">mfile</span>  <span class="o">=</span> <span class="s2">&quot;None&quot;</span>
    <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">mat_str</span> <span class="ow">in</span> <span class="n">vnames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">mat_str</span><span class="p">):</span>
            <span class="n">p_dict</span><span class="p">[</span><span class="n">mat_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">mat_str</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p_dict</span><span class="p">[</span><span class="n">mat_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">matrices</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="n">mat_str</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
                <span class="n">mfile</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;matrices&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error reading `&quot;</span><span class="o">+</span><span class="n">param_py</span><span class="o">.</span><span class="n">matrices</span><span class="o">+</span><span class="s2">&quot;`!&quot;</span><span class="p">)</span>
            <span class="n">arrcheck</span><span class="p">(</span><span class="n">p_dict</span><span class="p">[</span><span class="n">mat_str</span><span class="p">],</span><span class="s1">&#39;matrix&#39;</span><span class="p">,</span><span class="n">mat_str</span><span class="p">)</span>

    <span class="c1"># Try to load ROI names</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">matrices</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">mfile</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;matrices&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A NumPy 1darray or Python list of ROI names has to be either specified &quot;</span><span class="o">+</span>\
                             <span class="s2">&quot;in a matrix container or provided as keyword argument!&quot;</span><span class="p">)</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
        
    <span class="c1"># See if we have an (optional) list/array of ROI-shorthand labels</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">matrices</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">mfile</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;matrices&#39;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">):</span>
            <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>

    <span class="c1"># Put ones on the diagonal of the coupling matrix to ensure compatibility with the code</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="c1"># Get dimension of matrix and check correspondence</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">!=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dopamine and coupling matrices don&#39;t have the same dimension!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Matrix is &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-by-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; but `names` has length &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nm</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Names have to be provided as Python list/NumPy array of strings!&quot;</span><span class="p">)</span>

    <span class="c1"># If user provided some additional parameters as keyword arguments, copy them to `p_dict`</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">p_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Get synaptic couplings (and set seed of random number generator)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;aei&#39;</span><span class="p">):</span>
        <span class="n">aei</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;aei&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aei</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">aei</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;aie&#39;</span><span class="p">):</span>
        <span class="n">aie</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;aie&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">aie</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">aie</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;ani&#39;</span><span class="p">):</span>
        <span class="n">ani</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ani&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ani</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">ani</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;ane&#39;</span><span class="p">):</span>
        <span class="n">ane</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ane&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ane</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">ane</span><span class="p">)</span>

    <span class="c1"># If wanted, make sure left/right hemispheres have balanced coupling strengths</span>
    <span class="k">if</span> <span class="n">symsyn</span><span class="p">:</span>

        <span class="c1"># Get indices of left-hemispheric regions and throw a warning if left/right don&#39;t match up</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;[Ll]_*&quot;</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="nb">bool</span><span class="p">(</span><span class="n">regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">x</span><span class="p">)))(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">l_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">r_ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">l_ind</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">r_ind</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="nb">print</span> <span class="s2">&quot;WARNING: Number of left-side regions = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">l_ind</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">+</span>\
                  <span class="s2">&quot; not equal to number of right-side regions = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">r_ind</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            
        <span class="c1"># Equalize coupling strengths</span>
        <span class="n">aei</span><span class="p">[</span><span class="n">l_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">aei</span><span class="p">[</span><span class="n">r_ind</span><span class="p">]</span>
        <span class="n">aie</span><span class="p">[</span><span class="n">l_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">aie</span><span class="p">[</span><span class="n">r_ind</span><span class="p">]</span>
        <span class="n">ani</span><span class="p">[</span><span class="n">l_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ani</span><span class="p">[</span><span class="n">r_ind</span><span class="p">]</span>
        <span class="n">ane</span><span class="p">[</span><span class="n">l_ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">ane</span><span class="p">[</span><span class="n">r_ind</span><span class="p">]</span>

    <span class="c1"># Save updated coupling strengths and random number generator seed in dictionary</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;aei&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">aei</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;aie&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">aie</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;ani&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ani</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;ane&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ane</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">seed</span>

    <span class="c1"># If a resting state simulation is done, make sure dopamine doesn&#39;t kick in, i.e., enforce `rmax == rmin`</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">&#39;rest&#39;</span><span class="p">:</span>
        <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span><span class="o">*</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;rmin&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;rmax&#39;</span><span class="p">):</span>
            <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;rmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">rmax</span><span class="p">)</span>

    <span class="c1"># Save given task in dictionary</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;task&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>

    <span class="c1"># Get ion channel parameters</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;TCa&#39;</span><span class="p">):</span>
        <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;TCa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">param_py</span><span class="o">.</span><span class="n">TCa</span><span class="p">)</span>

    <span class="c1"># Compute length for simulation and speech on-/offset times</span>
    <span class="n">len_cycle</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;stimulus&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;production&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;acquisition&#39;</span><span class="p">]</span>
    <span class="n">speechon</span>  <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;stimulus&#39;</span><span class="p">]</span>
    <span class="n">speechoff</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;stimulus&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;production&#39;</span><span class="p">]</span>

    <span class="c1"># Save that stuff</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;len_cycle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_cycle</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;speechon&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">speechon</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;speechoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">speechoff</span>

    <span class="c1"># Set/get initial time for simulation</span>
    <span class="k">if</span> <span class="n">p_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;tstart&#39;</span><span class="p">):</span> 
        <span class="n">tstart</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">]</span>       <span class="c1"># Use `p_dict` here, since `tstart` could be a kwarg!</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;WARNING: Using custom initial time of  &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; (has to be in ms)!&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tstart</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Set/get step-size for simulation </span>
    <span class="k">if</span> <span class="n">p_dict</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">):</span> 
        <span class="n">dt</span> <span class="o">=</span> <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;WARNING: Using custom step-size of &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; (has to be in ms)!&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-1</span>

    <span class="c1"># Get sampling step size (in ms) and check if &quot;original&quot; step-size makes sense</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;s_rate&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
    <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">ds</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;WARNING: Step-size dt = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">+</span>\
              <span class="s2">&quot; larger than chosen sampling frequency of &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">s_rate</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;Hz.&quot;</span><span class="o">+</span>\
              <span class="s2">&quot; Using dt = &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;ms instead. &quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">ds</span>

    <span class="c1"># Compute sampling rate (w.r.t `dt`)</span>
    <span class="n">s_step</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ds</span><span class="o">/</span><span class="n">dt</span><span class="p">))</span>

    <span class="c1"># Save step-size and sampling rate in dictionary for later reference</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">dt</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;s_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_step</span>
        
    <span class="c1"># Compute end time for simulation (in ms) and allocate time-step array</span>
    <span class="n">tend</span>   <span class="o">=</span> <span class="n">tstart</span> <span class="o">+</span> <span class="n">len_cycle</span><span class="o">*</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;n_cycles&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">1000</span>
    <span class="n">tsteps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span><span class="n">tend</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>

    <span class="c1"># Get the size of the time-array</span>
    <span class="n">tsize</span>   <span class="o">=</span> <span class="n">tsteps</span><span class="o">.</span><span class="n">size</span>

    <span class="c1"># Before laying out output HDF5 container, rename existing files to not accidentally overwrite &#39;em</span>
    <span class="n">moveit</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    
    <span class="c1"># Chunk outifle depending on available memory (eat up ~ 100*`ram_use`% of RAM)</span>
    <span class="n">datype</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="n">meminfo</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span>
    <span class="n">maxmem</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">meminfo</span><span class="o">.</span><span class="n">available</span><span class="o">*</span><span class="n">ram_use</span><span class="o">/</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="n">datype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
    <span class="n">maxmem</span>  <span class="o">+=</span> <span class="n">s_step</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">maxmem</span><span class="p">,</span><span class="n">s_step</span><span class="p">)</span>

    <span class="c1"># If the whole array fits into memory load it once, otherwise chunk it up</span>
    <span class="k">if</span> <span class="n">tsteps</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">maxmem</span><span class="p">:</span>
        <span class="n">blocksize</span> <span class="o">=</span> <span class="p">[</span><span class="n">tsize</span><span class="p">]</span>
        <span class="n">csize</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tsize</span><span class="o">/</span><span class="n">s_step</span><span class="p">))</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="p">[</span><span class="n">csize</span><span class="p">]</span>
        <span class="n">chunks</span>    <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bsize</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tsize</span><span class="o">//</span><span class="n">maxmem</span><span class="p">)</span>
        <span class="n">rest</span>      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">tsize</span><span class="p">,</span><span class="n">maxmem</span><span class="p">))</span>
        <span class="n">blocksize</span> <span class="o">=</span> <span class="p">[</span><span class="n">maxmem</span><span class="p">]</span><span class="o">*</span><span class="n">bsize</span>
        <span class="k">if</span> <span class="n">rest</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">blocksize</span> <span class="o">=</span> <span class="n">blocksize</span> <span class="o">+</span> <span class="p">[</span><span class="n">rest</span><span class="p">]</span>
        <span class="n">numblocks</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
        <span class="n">csize</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">maxmem</span><span class="o">/</span><span class="n">s_step</span><span class="p">))</span>
        <span class="n">restc</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">blocksize</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">s_step</span><span class="p">))</span>
        <span class="n">chunksize</span> <span class="o">=</span> <span class="p">[</span><span class="n">csize</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">numblocks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">restc</span><span class="p">]</span>
        <span class="n">chunks</span>    <span class="o">=</span> <span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">csize</span><span class="p">)</span>

    <span class="c1"># Convert blocksize and chunksize to NumPy arrays</span>
    <span class="n">blocksize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
    <span class="n">chunksize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chunksize</span><span class="p">)</span>

    <span class="c1"># Get the number of elements that will be actually saved</span>
    <span class="n">n_elems</span> <span class="o">=</span> <span class="n">chunksize</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="c1"># Create output HDF5 container</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="c1"># Create datasets for numeric variables</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;C&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">n_elems</span><span class="p">),</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">n_elems</span><span class="p">),</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;DA&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">n_elems</span><span class="p">),</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;QV&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">n_elems</span><span class="p">),</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">n_elems</span><span class="p">),</span><span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;t&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span><span class="n">tend</span><span class="p">,</span><span class="n">n_elems</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>

    <span class="c1"># Save parameters (but exclude stuff imported in the parameter file)</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">value</span> <span class="ow">in</span> <span class="n">p_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">valuetype</span>  <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">valuetype</span> <span class="o">!=</span> <span class="s1">&#39;instance&#39;</span> <span class="ow">and</span> <span class="n">valuetype</span> <span class="o">!=</span> <span class="s1">&#39;module&#39;</span> <span class="ow">and</span> <span class="n">valuetype</span> <span class="o">!=</span> <span class="s1">&#39;function&#39;</span><span class="p">:</span>
            <span class="n">pg</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
    
    <span class="c1"># Close container and write to disk</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Initialize parameter C-class (struct) for the model</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">par</span><span class="p">(</span><span class="n">p_dict</span><span class="p">)</span>

    <span class="c1"># Concatenate initial conditions for the &quot;calibration&quot; run </span>
    <span class="n">VZD0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">V0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">Z0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">DA0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()])</span>

    <span class="c1"># Set up parameters for an initial `len_init` (in ms) long resting state simulation to &quot;calibrate&quot; the model</span>
    <span class="n">len_init</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">dt</span>       <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">s_step</span>   <span class="o">=</span> <span class="mi">10</span> 
    <span class="n">rmax</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,))</span>
    <span class="n">tinit</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">len_init</span><span class="p">,</span><span class="n">dt</span><span class="p">)</span>
    <span class="n">tsize</span>    <span class="o">=</span> <span class="n">tinit</span><span class="o">.</span><span class="n">size</span>
    <span class="n">csize</span>    <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">tsize</span><span class="o">/</span><span class="n">s_step</span><span class="p">))</span>

    <span class="c1"># Update `p_dict` (we don&#39;t use it anymore, so just overwrite stuff) </span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">dt</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;s_step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_step</span>
    <span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;rmax&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">rmax</span>
    <span class="n">parinit</span>          <span class="o">=</span> <span class="n">par</span><span class="p">(</span><span class="n">p_dict</span><span class="p">)</span>

    <span class="c1"># Create a temporary container for the simulation</span>
    <span class="n">tmpname</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span>
    <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpname</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">csize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">csize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;DA&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">csize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;QV&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">csize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;Beta&#39;</span><span class="p">,</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">csize</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="n">datype</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># Run 100ms of resting state to get model to a &quot;steady state&quot; for the initial conditions</span>
    <span class="n">solve_model</span><span class="p">(</span><span class="n">VZD0</span><span class="p">,</span><span class="n">tinit</span><span class="p">,</span><span class="n">parinit</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tsize</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">csize</span><span class="p">]),</span><span class="n">seed</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">tmpfile</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>

    <span class="c1"># Use final values of `V`, `Z` and `DA` as initial conditions for the &quot;real&quot; simulation</span>
    <span class="n">V0</span>   <span class="o">=</span> <span class="n">tmpfile</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">Z0</span>   <span class="o">=</span> <span class="n">tmpfile</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">DA0</span>  <span class="o">=</span> <span class="n">tmpfile</span><span class="p">[</span><span class="s1">&#39;DA&#39;</span><span class="p">][:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">VZD0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">V0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">Z0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span><span class="n">DA0</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()])</span>

    <span class="c1"># Close and delete the temporary container</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpname</span><span class="p">)</span>

    <span class="c1"># Let the user know what&#39;s going to happen...</span>
    <span class="n">pstr</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">pstr</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">pstr</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">pstr</span> <span class="o">=</span> <span class="n">pstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">Texttable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_deco</span><span class="p">(</span><span class="n">Texttable</span><span class="o">.</span><span class="n">HEADER</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_cols_align</span><span class="p">([</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_rows</span><span class="p">([[</span><span class="s2">&quot;Simulating &quot;</span><span class="p">,</span><span class="n">task</span><span class="o">.</span><span class="n">upper</span><span class="p">()],</span>\
                    <span class="p">[</span><span class="s2">&quot;#cycles: &quot;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">p_dict</span><span class="p">[</span><span class="s1">&#39;n_cycles&#39;</span><span class="p">])],</span>\
                    <span class="p">[</span><span class="s2">&quot;parameter file:&quot;</span><span class="p">,</span><span class="n">paramfile</span><span class="o">+</span><span class="s2">&quot;.py&quot;</span><span class="p">],</span>\
                    <span class="p">[</span><span class="s2">&quot;keyword args:&quot;</span><span class="p">,</span><span class="n">pstr</span><span class="p">],</span>\
                    <span class="p">[</span><span class="s2">&quot;matrix file:&quot;</span><span class="p">,</span><span class="n">mfile</span><span class="p">],</span>\
                    <span class="p">[</span><span class="s2">&quot;output:&quot;</span><span class="p">,</span><span class="n">outfile</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">table</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="c1"># Finally... run the actual simulation</span>
    <span class="n">solve_model</span><span class="p">(</span><span class="n">VZD0</span><span class="p">,</span><span class="n">tsteps</span><span class="p">,</span><span class="n">params</span><span class="p">,</span><span class="n">blocksize</span><span class="p">,</span><span class="n">chunksize</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">verbose</span><span class="p">),</span><span class="n">outfile</span><span class="p">)</span>

    <span class="c1"># Done!</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Done</span><span class="se">\n</span><span class="s2">&quot;</span></div>

<span class="c1">##########################################################################################</span>
<div class="viewcode-block" id="plot_sim"><a class="viewcode-back" href="../_stubs/sim_tools.plot_sim.html#sim_tools.plot_sim">[docs]</a><span class="k">def</span> <span class="nf">plot_sim</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span><span class="n">raw</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">bold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">figname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a simulation generated by `run_model`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        File-name (including path if not in working directory) of HDF5 container that was generated </span>
<span class="sd">        by `run_model`. </span>
<span class="sd">    names : str or Python list/NumPy 1darray</span>
<span class="sd">        Specify regions to plot. Either use the region&#39;s name as found in the `params` group of</span>
<span class="sd">        the HDF5 container given by `fname` (e.g., `names=&#39;L_IFG&#39;`) or its index in the `names` list</span>
<span class="sd">        (e.g., `names = 3`). Use a list or NumPy 1darray to specify more than one region</span>
<span class="sd">        (e.g., `names = [&#39;L_IFG&#39;,&#39;R_IFG&#39;]` or `names = [3,15]`). By default, all regions are plotted. </span>
<span class="sd">    raw : bool</span>
<span class="sd">        If `True` then the raw model output will be plotted. Depending on the setting of `names` (see</span>
<span class="sd">        above) the simulation length, and the model dimension (i.e., the number of modeled regions) </span>
<span class="sd">        this may result in a very &#39;busy&#39; plot. </span>
<span class="sd">    bold : bool</span>
<span class="sd">        If True then the previously converted simulated BOLD signals will be plotted (if no BOLD</span>
<span class="sd">        signal is found in the input container specified by `fname`, an error is raised). </span>
<span class="sd">    figname : str</span>
<span class="sd">        String to be used as window title for generated figures.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing : None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    None</span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    run_model : used to run a simulation</span>
<span class="sd">    make_bold : convert raw simulation output to a BOLD signal  </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make sure `fname` is a valid file-path</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">checkhdf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">peek</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Make sure `raw` and `bold` are either `True` or `False`</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The flag `raw` has to be Boolean!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bold</span><span class="p">,</span><span class="nb">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;The flag `bold` has to be Boolean!&quot;</span><span class="p">)</span>

    <span class="c1"># Try to access given HDF5 container</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rois_infile</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HDF5 file &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot; does not have the required fields!&quot;</span><span class="p">)</span>

    <span class="c1"># Check if list of ROI-names to plot was provided. If yes, make sure they make sense</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
        <span class="n">doleg</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Regions to plot have to be provided as Python list or NumPy 1darray!&quot;</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rois_infile</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region &quot;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;not found in file!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">names</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">idx</span>   <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rois_infile</span><span class="p">))</span>
            <span class="n">doleg</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">rois_infile</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region &quot;</span><span class="o">+</span><span class="n">names</span><span class="o">+</span><span class="s2">&quot;not found in file!&quot;</span><span class="p">)</span>
            <span class="n">doleg</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Check if `figname` is actually printable</span>
    <span class="k">if</span> <span class="n">figname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">figname</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Figure name has to be a string!&quot;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
        <span class="n">figname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span>

    <span class="c1"># Fix sorting of idx so that smart indexing below works</span>
    <span class="k">if</span> <span class="n">doleg</span><span class="p">:</span>
        <span class="n">idx</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">names</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="nb">sorted</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">names</span>  <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="nb">sorted</span><span class="p">]</span>
        <span class="n">idx</span>    <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="nb">sorted</span><span class="p">]</span>

    <span class="c1"># After all the error checking, reopen the file</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

    <span class="c1"># Turn on interactive plotting</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

    <span class="c1"># Plot raw model output</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">raw</span><span class="p">):</span>

        <span class="c1"># Compute plotting step size s.t. we plot every 100ms (=10Hz) (if possible)</span>
        <span class="n">s_rate</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;s_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="k">if</span> <span class="n">s_rate</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">p_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s_rate</span><span class="o">//</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_rate</span> <span class="o">=</span> <span class="n">s_rate</span>

        <span class="c1"># Get quantities for plotting</span>
        <span class="n">t</span>    <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;t&#39;</span><span class="p">][::</span><span class="n">p_rate</span><span class="p">]</span>
        <span class="n">V</span>    <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">,::</span><span class="n">p_rate</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">QV</span>   <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;QV&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">,::</span><span class="n">p_rate</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Beta</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Beta&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">,::</span><span class="n">p_rate</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">DA</span>   <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;DA&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">,::</span><span class="n">p_rate</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Prepare window and plot stuff</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">7.5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">figname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Raw Model Output from &quot;</span><span class="o">+</span><span class="n">fname</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">V</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doleg</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mV&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">QV</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Firing&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;QV&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Beta</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Gain Factor&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\beta$&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DA</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;mM&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">sp</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="n">tmax</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;ms&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DA&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1"># Plot raw model output</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bold</span><span class="p">):</span>
        
        <span class="c1"># Try to load the BOLD data from file</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">BOLD</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;BOLD&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No BOLD data found in file &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>

        <span class="c1"># Get x-extent of data and create x-ticks vector</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">BOLD</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">xtv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>

        <span class="c1"># Prepare window and plot stuff</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mf">7.5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">figname</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span> <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">set_window_title</span><span class="p">(</span><span class="n">figname</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;BOLD data &quot;</span><span class="o">+</span><span class="n">fname</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">BOLD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doleg</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xtv</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="p">[</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">]</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ymax</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Close file and return</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">##########################################################################################</span>
<div class="viewcode-block" id="make_D"><a class="viewcode-back" href="../_stubs/sim_tools.make_D.html#sim_tools.make_D">[docs]</a><span class="k">def</span> <span class="nf">make_D</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">names</span><span class="p">,</span><span class="n">values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create matrix of afferent/efferent dopamine regions in the model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target : Python list or NumPy 1darray</span>
<span class="sd">        Python list or NumPy 1darray of region names that are affected by dopamine release</span>
<span class="sd">        (has to be the same length as `source`).</span>
<span class="sd">    source : Python list or NumPy 1darray</span>
<span class="sd">        Python list or NumPy 1darray of region names that steer dopamine release. </span>
<span class="sd">        (has to be the same length as `target`).</span>
<span class="sd">    names : Python list or NumPy 1darray</span>
<span class="sd">        Names of all regions in the model. If `names` has length `N`, the resulting </span>
<span class="sd">        dopamine connection matrix will by `N`-by-`N`. </span>
<span class="sd">    values : Python list or NumPy 1darray</span>
<span class="sd">        By default, dopamine links are binary, i.e., all links have unit weight. By passing </span>
<span class="sd">        a `values` array, certain links can be emphasized (weight &gt; 1) or weakened (weight &lt; 1). </span>
<span class="sd">        Entries of the `values` array have to be calibrated based on the values of `b_hi`, `b_lo`, </span>
<span class="sd">        and `a`. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    D : NumPy 2darray</span>
<span class="sd">        A `N`-by-`N` array. Every row that has a non-zero entry signifies a dopamine target, </span>
<span class="sd">        and every non-zero column corresponds to a dopamine source. </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    None</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    For the sake of simplicity consider a brain &quot;parcellation&quot; consisting of three (bilateral) regions, </span>
<span class="sd">    called `A`, `B`, and `C`. Thus, we define the following `names` array</span>

<span class="sd">    &gt;&gt;&gt; names = [&#39;L_A&#39;,&#39;L_B&#39;,&#39;L_C&#39;,&#39;R_A&#39;,&#39;R_B&#39;,&#39;R_C&#39;]</span>

<span class="sd">    Assume that in the left hemisphere dopamine is mainly concentrated in region `B`, its release is </span>
<span class="sd">    steered by neural firing in region `A`. In the right hemisphere, dopamine release in region `C` is </span>
<span class="sd">    depending on neural activity in area `B`. Then the `target` and `source` arrays are given by</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; target = [&#39;L_B&#39;,&#39;R_C&#39;]</span>
<span class="sd">    &gt;&gt;&gt; source = [&#39;L_A&#39;,&#39;R_B&#39;]</span>

<span class="sd">    Then the call</span>

<span class="sd">    &gt;&gt;&gt; D = make_D(target,source,names)</span>
<span class="sd">    &gt;&gt;&gt; D</span>
<span class="sd">    array([[ 0.,  0.,  0.,  0.,  0.,  0.],</span>
<span class="sd">           [ 1.,  0.,  0.,  0.,  0.,  0.],</span>
<span class="sd">           [ 0.,  0.,  0.,  0.,  0.,  0.],</span>
<span class="sd">           [ 0.,  0.,  0.,  0.,  0.,  0.],</span>
<span class="sd">           [ 0.,  0.,  0.,  0.,  0.,  0.],</span>
<span class="sd">           [ 0.,  0.,  0.,  0.,  1.,  0.]])</span>

<span class="sd">    generates a 6-by-6 NumPy array `D`, that has non-zero entries in rows 2 and 6 (because</span>
<span class="sd">    &#39;L_B&#39; is the second, and &#39;R_C&#39; the sixth element of the list `names`), and columns 1 and 5 </span>
<span class="sd">    (because &#39;L_A&#39; is the first, and &#39;R_B&#39; the 5th element of the list `names`). Thus, the row/column</span>
<span class="sd">    index of each non-zero entry in `D` has the format target-by-source. </span>

<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Sanity checks</span>
    <span class="n">vnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">,</span><span class="s2">&quot;source&quot;</span><span class="p">,</span><span class="s2">&quot;names&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tk</span><span class="p">,</span> <span class="n">tsn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">target</span><span class="p">,</span><span class="n">source</span><span class="p">,</span><span class="n">names</span><span class="p">]):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tsn</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tsn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Inputs target, source and names have to be NumPy 1darrays or Python lists, not &quot;</span><span class="o">+</span>\
                  <span class="nb">type</span><span class="p">(</span><span class="n">tsn</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">tsn</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All elements of `&quot;</span><span class="o">+</span><span class="n">vnames</span><span class="p">[</span><span class="n">tk</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;` have to be strings!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of source and target lists/arrays does not match up!&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tk</span><span class="p">,</span> <span class="n">tsn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">target</span><span class="p">,</span><span class="n">source</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">tsn</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">el</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Element `&quot;</span><span class="o">+</span><span class="n">el</span><span class="o">+</span><span class="s2">&quot;` not found in `&quot;</span><span class="o">+</span><span class="n">vnames</span><span class="p">[</span><span class="n">tk</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;`!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">values</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">arrcheck</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="s1">&#39;vector&#39;</span><span class="p">,</span><span class="s1">&#39;values&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Length of `values` list/array does not match up!&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">target</span><span class="p">),))</span>

    <span class="c1"># Convert (if we&#39;re having a NumPy array) `names` to a Python list</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

    <span class="c1"># Get dimension we&#39;re dealing with here</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>

    <span class="c1"># Create dopamine matrix</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>

    <span class="c1"># Fill the matrix</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)):</span>

        <span class="c1"># Get row and column indices</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># Matrix is targets-by-sources</span>
        <span class="n">D</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">D</span></div>

<span class="c1">##########################################################################################</span>
<div class="viewcode-block" id="make_bold"><a class="viewcode-back" href="../_stubs/sim_tools.make_bold.html#sim_tools.make_bold">[docs]</a><span class="k">def</span> <span class="nf">make_bold</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">stim_onset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert raw model output to BOLD signal</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        File-name (including path if not in working directory) of HDF5 container that was generated </span>
<span class="sd">        by `run_model`. </span>
<span class="sd">    stim_onset : float</span>
<span class="sd">        Time (in seconds) of stimulus onset. By default, onset/offset timings of </span>
<span class="sd">        stimuli are stored in the HDF5 container generated by `run_model`. Only override </span>
<span class="sd">        this setting, if you know what you are doing. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing : None</span>
<span class="sd">        The computed BOLD signal is stored as dataset `BOLD` at the top level of the HDF5 container </span>
<span class="sd">        specified by `fname`. </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Regional neural voltages are converted to BOLD time-series using the linear hemodynamic response </span>
<span class="sd">    function proposed by Glover [1]_. For details consult the supporting information of our </span>
<span class="sd">    paper [2]_. </span>


<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Glover G. Deconvolution of Impulse Response in Event-Related BOLD FMRI. </span>
<span class="sd">           NeuroImage 9: 416-429, 1999.</span>

<span class="sd">    .. [2] S. Fuertinger, J. C. Zinn, and K. Simonyan. A Neural Population Model Incorporating </span>
<span class="sd">           Dopaminergic Neurotransmission during Complex Voluntary Behaviors. PLoS Computational Biology, </span>
<span class="sd">           10(11), 2014. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Make sure container exists and is valid</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">checkhdf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">peek</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="k">except</span><span class="p">:</span> 
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HDF5 file &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot; does not have the required fields!&quot;</span><span class="p">)</span>

    <span class="c1"># Compute cycle length based on the sampling rate used to generate the file</span>
    <span class="n">N</span>         <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">s_rate</span>    <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;s_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">n_cycles</span>  <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;n_cycles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">len_cycle</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;len_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">cycle_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">s_rate</span><span class="o">*</span><span class="n">len_cycle</span><span class="p">))</span>

    <span class="c1"># Make sure `stim_onset` makes sense</span>
    <span class="k">if</span> <span class="n">stim_onset</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scalarcheck</span><span class="p">(</span><span class="n">stim_onset</span><span class="p">,</span><span class="s1">&#39;stim_onset&#39;</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">len_cycle</span><span class="p">])</span>

    <span class="c1"># Get task from file to start sub-sampling procedure</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;task&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Compute cycle length based on the sampling rate used to generate the file</span>
    <span class="n">N</span>         <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">n_cycles</span>  <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;n_cycles&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">len_cycle</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;len_cycle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">cycle_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">s_rate</span><span class="o">*</span><span class="n">len_cycle</span><span class="p">))</span>

    <span class="c1"># Compute step size and (if not provided by the user) compute stimulus onset time</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s_rate</span>
    <span class="k">if</span> <span class="n">stim_onset</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stim_onset</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;stimulus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    
    <span class="c1"># Use Glover&#39;s Hemodynamic response function as convolution kernel (with default length 32)</span>
    <span class="n">hrft</span>       <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">lambdify_t</span><span class="p">(</span><span class="n">hrf</span><span class="o">.</span><span class="n">glover</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
    <span class="n">hrf_kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">s_rate</span><span class="o">*</span><span class="n">stim_onset</span><span class="p">),)),</span><span class="n">hrft</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="n">dt</span><span class="p">))))</span>

    <span class="c1"># Convolve the de-meaned model time-series with the kernel </span>
    <span class="n">convV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">convolve1d</span><span class="p">((</span><span class="n">V</span><span class="o">.</span><span class="n">T</span> <span class="o">-</span> <span class="n">V</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">hrf_kernel</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>

    <span class="c1"># Allocate space for BOLD signal</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span><span class="n">n_cycles</span><span class="p">))</span>

    <span class="c1"># Sub-sample convoluted data depending on task to get BOLD signal</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">&#39;speech&#39;</span><span class="p">:</span>

        <span class="c1"># Get interval to be considered for boldification</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;speechoff&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">s_rate</span><span class="p">))</span>
        <span class="n">stop</span>  <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;acquisition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">s_rate</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">task</span> <span class="o">==</span> <span class="s1">&#39;rest&#39;</span><span class="p">:</span>

        <span class="c1"># Get interval to be considered for boldification</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">stop</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;stimulus&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">s_rate</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t know what to do for task &quot;</span><span class="o">+</span><span class="n">task</span><span class="p">)</span>

    <span class="c1"># Compute BOLD signal for all time points</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n_cycles</span><span class="p">):</span>
        <span class="n">BOLD</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">convV</span><span class="p">[:,</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">+=</span> <span class="n">cycle_idx</span>
        <span class="n">stop</span>  <span class="o">+=</span> <span class="n">cycle_idx</span>

    <span class="c1"># Re-scale the the signal</span>
    <span class="n">BOLD</span> <span class="o">=</span> <span class="n">BOLD</span><span class="o">*</span><span class="mf">0.02</span>

    <span class="c1"># Save it to the file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;BOLD&#39;</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">BOLD</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">f</span><span class="p">[</span><span class="s1">&#39;BOLD&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write_direct</span><span class="p">(</span><span class="n">BOLD</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<span class="c1">##########################################################################################</span>
<div class="viewcode-block" id="show_params"><a class="viewcode-back" href="../_stubs/sim_tools.show_params.html#sim_tools.show_params">[docs]</a><span class="k">def</span> <span class="nf">show_params</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pretty-print all parameters used in a simulation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fname : str</span>
<span class="sd">        Filename (including path if not in working directory) of HDF5 container that was generated </span>
<span class="sd">        by `run_model`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Nothing : None</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    None</span>
<span class="sd">    </span>
<span class="sd">    See also</span>
<span class="sd">    --------</span>
<span class="sd">    None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make sure container exists and is valid</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">checkhdf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">peek</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">par_grp</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HDF5 file &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot; does not have the required fields!&quot;</span><span class="p">)</span>

    <span class="c1"># Create a list for Texttable</span>
    <span class="n">tlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">tlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

    <span class="c1"># Close file</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Print table</span>
    <span class="nb">print</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Showing parameters of file &quot;</span><span class="o">+</span><span class="n">fname</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">Texttable</span><span class="p">()</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_deco</span><span class="p">(</span><span class="n">Texttable</span><span class="o">.</span><span class="n">HEADER</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">set_cols_align</span><span class="p">([</span><span class="s2">&quot;l&quot;</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">])</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_rows</span><span class="p">([[</span><span class="s2">&quot;Parameter&quot;</span><span class="p">,</span><span class="s2">&quot;Value&quot;</span><span class="p">]],</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">table</span><span class="o">.</span><span class="n">add_rows</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">table</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span></div>
    
<span class="c1">##########################################################################################</span>
<span class="k">def</span> <span class="nf">arrcheck</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local helper function performing sanity checks on arrays (1d/2d/3d)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sha</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input &#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39; must be a NumPy array, not &#39;</span><span class="o">+</span><span class="nb">type</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">+</span><span class="s1">&#39;!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;tensor&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a `N`-by-`N`-by-`k` NumPy array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sha</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">sha</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">sha</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a `N`-by-`N`-by-`k` NumPy array!&#39;</span><span class="p">)</span>
        <span class="n">dim_msg</span> <span class="o">=</span> <span class="s1">&#39;`N`-by-`N`-by-`k`&#39;</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;matrix&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a `N`-by-`N` NumPy array&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sha</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">sha</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a `N`-by-`N` NumPy array!&#39;</span><span class="p">)</span>
        <span class="n">dim_msg</span> <span class="o">=</span> <span class="s1">&#39;`N`-by-`N`&#39;</span>
    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;vector&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a NumPy 1darray&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">sha</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a NumPy 1darray of length `N`!&#39;</span><span class="p">)</span>
        <span class="n">dim_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;Error checking could not be performed - something&#39;s wrong here...&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">plt</span><span class="o">.</span><span class="n">is_numlike</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a real-valued &#39;</span><span class="o">+</span><span class="n">dim_msg</span><span class="o">+</span><span class="s1">&#39; NumPy array!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input `&#39;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s1">&#39;` must be a real valued NumPy array without Infs or NaNs!&#39;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">arr</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Values of input array `&quot;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s2">&quot;` must be between &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span>\
                             <span class="s2">&quot; and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>

<span class="c1">##########################################################################################</span>
<span class="k">def</span> <span class="nf">scalarcheck</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="n">varname</span><span class="p">,</span><span class="n">kind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local helper function performing sanity checks on scalars</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">plt</span><span class="o">.</span><span class="n">is_numlike</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isreal</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input `&quot;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s2">&quot;` must be a real scalar!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input `&quot;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s2">&quot;` must be finite!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input `&quot;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s2">&quot;` must be an integer!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bounds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input scalar `&quot;</span><span class="o">+</span><span class="n">varname</span><span class="o">+</span><span class="s2">&quot;` must be between &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot; and &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>

<span class="c1">##########################################################################################</span>
<span class="k">def</span> <span class="nf">checkhdf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">peek</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Local helper function performing sanity checks on file-names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Make sure `fname` is a valid file-path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fname</span><span class="p">,(</span><span class="nb">str</span><span class="p">,</span><span class="n">unicode</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Name of HDF5 file has to be a string!&quot;</span><span class="p">)</span>
    <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fname</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">fname</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File: &#39;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s1">&#39; does not exist!&#39;</span><span class="p">)</span>

    <span class="c1"># Additionally, try opening the container if wanted</span>
    <span class="k">if</span> <span class="n">peek</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot open &quot;</span><span class="o">+</span><span class="n">fname</span><span class="o">+</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.6.<br/>
    </p>
  </div>
</footer>
  </body>
</html>